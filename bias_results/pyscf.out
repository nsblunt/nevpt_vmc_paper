#INFO: **** input file is /home/nsb37/testing/VMC/virtual_scaling/vdz/prepVMC.py ****
import numpy as np
import math
from pyscf import gto, scf, ao2mo, mcscf, tools, fci, mp
from pyscf.lo import pipek, boys
import sys
from scipy.linalg import fractional_matrix_power
import scipy.linalg as la
import os
import NEVPT2Helper as nev

def doRHF(mol):
  mf = scf.RHF(mol)
  print (mf.kernel())
  return mf


# make your molecule here
r = 2.5 * 0.529177
atomstring = "N 0 0 0; N 0 0 %g"%(r)
mol = gto.M(
    atom = atomstring,
#    basis = 'ccpvtz',
    basis = 'cc-pvdz',
    verbose=4,
    symmetry=0,
    spin = 0)

mf = doRHF(mol)
mc = mcscf.CASSCF(mf, 8, 10)
mc.kernel()

#print (mrpt.sc_nevpt(mc))
print ("moEne")

for i in range(28):
  print (mc.mo_energy[i])

tools.fcidump.from_mo(mol, 'FCIDUMP_all_orbs', mc.mo_coeff)

#this is the scratch file for writing potentially larger integral files
intfolder = "int/"
os.system("mkdir -p "+intfolder)

#this code will be used for generating the files that are needed for deterministic PT
from pyscf.shciscf import shci
mc2 = shci.SHCISCF(mf, 8, 10)
mc2.max_cycle_macro=0
mc2.mo_coeff = 1.*mc.mo_coeff

mc2.fcisolver.sweep_iter = [0]
mc2.fcisolver.sweep_epsilon = [0.0]

ecas=mc2.kernel(mc.mo_coeff)[0]
dm1, dm2a = mc2.fcisolver.make_rdm12(0, mc.ncas, mc.nelecas)
dm2 = np.einsum('ijkl->ikjl', dm2a)

np.save(intfolder+"E2.npy", np.asfortranarray(dm2))
np.save(intfolder+"E1.npy", np.asfortranarray(dm1))

print ("trace of 2rdm", np.einsum('ijij',dm2))
print ("trace of 1rdm", np.einsum('ii',dm1))

nfro = 0
E1eff = dm1 #for state average
nev.writeNEVPTIntegrals(mc2, dm1, dm2, E1eff, nfro, intfolder)
nev.write_ic_inputs(mc.nelecas[0]+mc.nelecas[1], mc.ncore, mc.ncas, nfro, mc.nelecas[0]-mc.nelecas[1],
                   'NEVPT2')
#INFO: ******************** input file end ********************


System: ('Linux', 'magneto', '4.4.0-171-generic', '#200-Ubuntu SMP Tue Dec 3 11:04:55 UTC 2019', 'x86_64', 'x86_64')  Threads 1
Python 2.7.15 |Anaconda, Inc.| (default, May  1 2018, 23:32:55) 
[GCC 7.2.0]
numpy 1.16.5  scipy 1.1.0
Date: Fri Jan 24 14:45:27 2020
PySCF version 1.6.5
PySCF path  /home/nsb37/pyscf/pyscf
GIT ORIG_HEAD 8742ca3f79161a21c2e2c2a938155103801720ba
GIT HEAD      ref: refs/heads/master
GIT master branch  3e78524f269bd74924c9d5bb5b63f72d2f9e9dee

[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 2
[INPUT] num. electrons = 14
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry 0 subgroup None
[INPUT] Mole.unit = angstrom
[INPUT]  1 N      0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr
[INPUT]  2 N      0.000000000000   0.000000000000   1.322940000000 AA    0.000000000000   0.000000000000   2.499994279232 Bohr

nuclear repulsion = 19.6000448509229
number of shells = 10
number of NR pGTOs = 52
number of NR cGTOs = 28
basis = cc-pvdz
ecp = {}
CPU time:         0.63


******** <class 'pyscf.scf.hf.RHF'> ********
method = RHF
initial guess = minao
damping factor = 0
level_shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
diis_start_cycle = 1
diis_space = 8
SCF conv_tol = 1e-09
SCF conv_tol_grad = None
SCF max_cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /scratch/nsb37/TMPDIR/tmpNErGA5
max_memory 4000 MB (current use 60 MB)
Set gradient conv threshold to 3.16228e-05
init E= -108.350667827743
  HOMO = -0.344416890719614  LUMO = -0.00411524198230178
cycle= 1 E= -108.800162912122  delta_E= -0.449  |g|= 0.319  |ddm|= 1.62
  HOMO = -0.576626600901737  LUMO = 0.0250314131723953
cycle= 2 E= -108.823943356868  delta_E= -0.0238  |g|= 0.0743  |ddm|= 0.297
  HOMO = -0.525102748716944  LUMO = 0.0752801467431859
cycle= 3 E= -108.825515487679  delta_E= -0.00157  |g|= 0.0167  |ddm|= 0.0628
  HOMO = -0.528883462852364  LUMO = 0.0725593219314252
cycle= 4 E= -108.825634685301  delta_E= -0.000119  |g|= 0.000874  |ddm|= 0.0249
  HOMO = -0.528532332706333  LUMO = 0.0729495748839175
cycle= 5 E= -108.825634881868  delta_E= -1.97e-07  |g|= 8.04e-05  |ddm|= 0.000918
  HOMO = -0.528556833336487  LUMO = 0.0729245639469054
cycle= 6 E= -108.825634883744  delta_E= -1.88e-09  |g|= 9.17e-06  |ddm|= 7.92e-05
  HOMO = -0.528555690430599  LUMO = 0.0729267702681059
cycle= 7 E= -108.825634883769  delta_E= -2.42e-11  |g|= 7.36e-07  |ddm|= 1.19e-05
  HOMO = -0.528555791626746  LUMO = 0.0729266579704689
Extra cycle  E= -108.825634883769  delta_E= -2.84e-13  |g|= 2.17e-07  |ddm|= 8.57e-07
converged SCF energy = -108.825634883769
-108.82563488376884

******** <class 'pyscf.mcscf.mc1step.CASSCF'> ********
CAS (5e+5e, 8o), ncore = 2, nvir = 18
max_cycle_macro = 50
max_cycle_micro = 4
conv_tol = 1e-07
conv_tol_grad = None
orbital rotation max_stepsize = 0.02
augmented hessian ah_max_cycle = 30
augmented hessian ah_conv_tol = 1e-12
augmented hessian ah_linear dependence = 1e-14
augmented hessian ah_level shift = 0
augmented hessian ah_start_tol = 2.5
augmented hessian ah_start_cycle = 3
augmented hessian ah_grad_trust_region = 3
kf_trust_region = 3
kf_interval = 4
ci_response_space = 4
ci_grad_trust_region = 3
with_dep4 0
natorb = False
canonicalization = True
sorting_mo_energy = False
ao2mo_level = 2
chkfile = /scratch/nsb37/TMPDIR/tmpNErGA5
max_memory 4000 MB (current use 80 MB)
internal_rotation = False
******** <class 'pyscf.fci.direct_spin1.FCISolver'> ********
max. cycles = 50
conv_tol = 1e-08
davidson only = False
linear dependence = 1e-10
level shift = 0.001
max iter space = 12
max_memory 4000 MB
nroots = 1
pspace_size = 400
spin = None
CASCI E = -108.975478315292  S^2 = 0.0000000
Set conv_tol_grad to 0.000316228
macro iter 1 (21 JK  4 micro), CASSCF E = -109.019487180858  dE = -0.044008866  S^2 = 0.0000000
               |grad[o]|=0.111  |grad[c]|= 0.04161959697418875  |ddm|=0.0308
macro iter 2 (20 JK  4 micro), CASSCF E = -109.034702330604  dE = -0.01521515  S^2 = 0.0000000
               |grad[o]|=0.0611  |grad[c]|= 0.01686538924714424  |ddm|=0.0128
macro iter 3 (9 JK  3 micro), CASSCF E = -109.034709931131  dE = -7.6005272e-06  S^2 = 0.0000000
               |grad[o]|=0.00246  |grad[c]|= 5.0404179769591114e-05  |ddm|=0.000985
macro iter 4 (1 JK  1 micro), CASSCF E = -109.034709931149  dE = -1.7848834e-11  S^2 = 0.0000000
               |grad[o]|=1.33e-05  |grad[c]|= 5.938990451208259e-06  |ddm|=6.14e-07
1-step CASSCF converged in 4 macro (51 JK 12 micro) steps
CASSCF canonicalization
Density matrix diagonal elements [1.98551774 1.9871957  1.97033316 1.88898599 1.88898599 0.118538
 0.118538   0.04190541]
CASSCF energy = -109.034709931149
CASCI E = -109.034709931149  E(CI) = -29.602771148269  S^2 = 0.0000000
moEne
-15.6757542170503
-15.663618731871694
-1.302327327379655
-0.8206458359595331
-0.5712563737048973
-0.49121859740678886
-0.49121859740679025
0.1371993683698809
0.13719936836987298
0.6712849071950377
0.7661558474606839
0.9216522087415412
0.9275452460647566
0.9275452460647838
0.9630707254708277
0.9630707254708439
0.9999666694785747
1.474220742673621
1.7440790488825932
1.7440790488826043
1.8555099175149874
1.8555099175149992
2.1854011580734887
2.1854011580734904
2.5267576703479087
2.757444267322972
2.7574442673229753
3.06599286029914

******** <class 'pyscf.mcscf.mc1step.CASSCF'> ********
CAS (5e+5e, 8o), ncore = 2, nvir = 18
max_cycle_macro = 0
max_cycle_micro = 4
conv_tol = 1e-07
conv_tol_grad = None
orbital rotation max_stepsize = 0.02
augmented hessian ah_max_cycle = 30
augmented hessian ah_conv_tol = 1e-12
augmented hessian ah_linear dependence = 1e-14
augmented hessian ah_level shift = 0
augmented hessian ah_start_tol = 2.5
augmented hessian ah_start_cycle = 3
augmented hessian ah_grad_trust_region = 3
kf_trust_region = 3
kf_interval = 4
ci_response_space = 4
ci_grad_trust_region = 3
with_dep4 0
natorb = False
canonicalization = True
sorting_mo_energy = False
ao2mo_level = 2
chkfile = /scratch/nsb37/TMPDIR/6054/tmp5ZxChn
max_memory 4000 MB (current use 94 MB)
internal_rotation = False

******** SHCI flags ********
executable             = /home/nsb37/Dice_github/Dice
mpiprefix              = mpirun -np 1
scratchDirectory       = /scratch/nsb37/TMPDIR/6054
integralFile           = ./FCIDUMP
configFile             = ./input.dat
outputFile             = ./output.dat
maxIter                = 6
sweep_iter             = [    0]
sweep_epsilon          = [  0.0]
nPTiter                = 0
Stochastic             = True
restart                = False
fullrestart            = False
num_thrds              = 1
memory                 = None

CASCI E = -109.03470993085  S^2 = 0.0000000
Set conv_tol_grad to 0.000316228
1-step CASSCF not converged, 0 macro (0 JK 0 micro) steps
CASSCF canonicalization
Density matrix diagonal elements [1.98551726 1.98719772 1.97033347 1.8889827  1.8889827  0.11854044
 0.11854044 0.04190543]
CASSCF energy = -109.03470993085
CASCI E = -109.03470993085  E(CI) = -29.6027711479702  S^2 = 0.0000000
('trace of 2rdm', 90.00000147800893)
('trace of 1rdm', 10.000000164223215)
Producing the integrals
......production of INT took       0.01 sec

Energy_nuc  =   19.60004485
Energy_core =  -99.03198363
Energy      = -109.03471039

('Basic ingredients written to int/', 0, 2, 10, 28)
......savings of INGREDIENTS took       0.00 sec

......Calculating the printing the SC norms for AAVV, CCAA, CAAV
AAVV
       0         0      0.00591040064648
       0         1      0.00464306514199
       0         2      0.00355225834232
       0         3      0.00355225834232
       0         4      0.00178846187669
       0         5      0.00178846187669
       0         6      0.00571127618160
       0         7      0.00267100409672
       0         8      0.00018783165010
       0         9      0.00018783165010
       0        10      0.00003482189706
       0        11      0.00003482222617
       0        12      0.00012380562640
       0        13      0.00012380574696
       0        14      0.00035505502093
       0        15      0.00015927683588
       0        16      0.00015927683588
       0        17      0.00030512225116
       1         0      0.00464306514199
       1         1      0.01027502241729
       1         2      0.00803425121309
       1         3      0.00803425121309
       1         4      0.00122827379575
       1         5      0.00122827379575
       1         6      0.00686815543170
       1         7      0.00337439366907
       1         8      0.00333936445096
       1         9      0.00333936445096
       1        10      0.00106049528410
       1        11      0.00106049617101
       1        12      0.00005780019386
       1        13      0.00005780039084
       1        14      0.00181389032477
       1        15      0.00019885058497
       1        16      0.00019885058497
       1        17      0.00079478994870
       2         0      0.00355225834232
       2         1      0.00803425121309
       2         2      0.00693999449425
       2         3      0.00775131469075
       2         4      0.00102393526214
       2         5      0.00096467421336
       2         6      0.00770082355784
       2         7      0.00506655865154
       2         8      0.00026342234535
       2         9      0.00130243496619
       2        10      0.00062190803002
       2        11      0.00062190803002
       2        12      0.00045261877128
       2        13      0.00045261877128
       2        14      0.00042968079279
       2        15      0.00007840279278
       2        16      0.00051699308576
       2        17      0.00051591669569
       3         0      0.00355225834232
       3         1      0.00803425121309
       3         2      0.00775131469075
       3         3      0.00693999449425
       3         4      0.00096467421336
       3         5      0.00102393526214
       3         6      0.00770082355784
       3         7      0.00506655865154
       3         8      0.00130243496619
       3         9      0.00026342234535
       3        10      0.00062190803002
       3        11      0.00062190803002
       3        12      0.00045261877128
       3        13      0.00045261877128
       3        14      0.00042968079279
       3        15      0.00051699308576
       3        16      0.00007840279278
       3        17      0.00051591669569
       4         0      0.00178846187669
       4         1      0.00122827379575
       4         2      0.00102393526214
       4         3      0.00096467421336
       4         4      0.00162625701904
       4         5      0.00116229175404
       4         6      0.00257854850624
       4         7      0.00194211814680
       4         8      0.00002060921909
       4         9      0.00005505576335
       4        10      0.00003413207335
       4        11      0.00003413207335
       4        12      0.00014658620675
       4        13      0.00014658620675
       4        14      0.00022434951891
       4        15      0.00020381135541
       4        16      0.00012464344301
       4        17      0.00079958292364
       5         0      0.00178846187669
       5         1      0.00122827379575
       5         2      0.00096467421336
       5         3      0.00102393526214
       5         4      0.00116229175404
       5         5      0.00162625701904
       5         6      0.00257854850624
       5         7      0.00194211814680
       5         8      0.00005505576335
       5         9      0.00002060921909
       5        10      0.00003413207335
       5        11      0.00003413207335
       5        12      0.00014658620675
       5        13      0.00014658620675
       5        14      0.00022434951891
       5        15      0.00012464344301
       5        16      0.00020381135541
       5        17      0.00079958292364
       6         0      0.00571127618160
       6         1      0.00686815543170
       6         2      0.00770082355784
       6         3      0.00770082355784
       6         4      0.00257854850624
       6         5      0.00257854850624
       6         6      0.01278194606560
       6         7      0.00621394681846
       6         8      0.00249974203708
       6         9      0.00249974203708
       6        10      0.00048343005089
       6        11      0.00048342895880
       6        12      0.00001025004049
       6        13      0.00001025009894
       6        14      0.00249227392245
       6        15      0.00043714322404
       6        16      0.00043714322404
       6        17      0.00040402486402
       7         0      0.00267100409672
       7         1      0.00337439366907
       7         2      0.00506655865154
       7         3      0.00506655865154
       7         4      0.00194211814680
       7         5      0.00194211814680
       7         6      0.00621394681846
       7         7      0.00476314361136
       7         8      0.00036621370623
       7         9      0.00036621370623
       7        10      0.00000008495571
       7        11      0.00000008495652
       7        12      0.00002174825882
       7        13      0.00002174824168
       7        14      0.00098668779684
       7        15      0.00049735267177
       7        16      0.00049735267177
       7        17      0.00107558697129
       8         0      0.00018783165010
       8         1      0.00333936445096
       8         2      0.00026342234535
       8         3      0.00130243496619
       8         4      0.00002060921909
       8         5      0.00005505576335
       8         6      0.00249974203708
       8         7      0.00036621370623
       8         8      0.02109953505363
       8         9      0.00521689886253
       8        10      0.00708979535050
       8        11      0.00708979535050
       8        12      0.00180125724078
       8        13      0.00180125724078
       8        14      0.00786843487117
       8        15      0.00522908751617
       8        16      0.00180605864653
       8        17      0.00124203842194
       9         0      0.00018783165010
       9         1      0.00333936445096
       9         2      0.00130243496619
       9         3      0.00026342234535
       9         4      0.00005505576335
       9         5      0.00002060921909
       9         6      0.00249974203708
       9         7      0.00036621370623
       9         8      0.00521689886253
       9         9      0.02109953505363
       9        10      0.00708979535050
       9        11      0.00708979535050
       9        12      0.00180125724078
       9        13      0.00180125724078
       9        14      0.00786843487117
       9        15      0.00180605864653
       9        16      0.00522908751617
       9        17      0.00124203842194
      10         0      0.00003482189706
      10         1      0.00106049528410
      10         2      0.00062190803002
      10         3      0.00062190803002
      10         4      0.00003413207335
      10         5      0.00003413207335
      10         6      0.00048343005089
      10         7      0.00000008495571
      10         8      0.00708979535050
      10         9      0.00708979535050
      10        10      0.01301222712574
      10        11      0.01328957863575
      10        12      0.00206976816950
      10        13      0.00405899840955
      10        14      0.00082796549693
      10        15      0.00054471071417
      10        16      0.00054471071417
      10        17      0.00012000905960
      11         0      0.00003482222617
      11         1      0.00106049617101
      11         2      0.00062190803002
      11         3      0.00062190803002
      11         4      0.00003413207335
      11         5      0.00003413207335
      11         6      0.00048342895880
      11         7      0.00000008495652
      11         8      0.00708979535050
      11         9      0.00708979535050
      11        10      0.01328957863575
      11        11      0.01301222712574
      11        12      0.00405899840955
      11        13      0.00206976816950
      11        14      0.00082796960982
      11        15      0.00054471071417
      11        16      0.00054471071417
      11        17      0.00012001019017
      12         0      0.00012380562640
      12         1      0.00005780019386
      12         2      0.00045261877128
      12         3      0.00045261877128
      12         4      0.00014658620675
      12         5      0.00014658620675
      12         6      0.00001025004049
      12         7      0.00002174825882
      12         8      0.00180125724078
      12         9      0.00180125724078
      12        10      0.00206976816950
      12        11      0.00405899840955
      12        12      0.00652577924009
      12        13      0.00411425564479
      12        14      0.00021316164550
      12        15      0.00197237677929
      12        16      0.00197237677929
      12        17      0.00049252010542
      13         0      0.00012380574696
      13         1      0.00005780039084
      13         2      0.00045261877128
      13         3      0.00045261877128
      13         4      0.00014658620675
      13         5      0.00014658620675
      13         6      0.00001025009894
      13         7      0.00002174824168
      13         8      0.00180125724078
      13         9      0.00180125724078
      13        10      0.00405899840955
      13        11      0.00206976816950
      13        12      0.00411425564479
      13        13      0.00652577924009
      13        14      0.00021316233794
      13        15      0.00197237677929
      13        16      0.00197237677929
      13        17      0.00049252059613
      14         0      0.00035505502093
      14         1      0.00181389032477
      14         2      0.00042968079279
      14         3      0.00042968079279
      14         4      0.00022434951891
      14         5      0.00022434951891
      14         6      0.00249227392245
      14         7      0.00098668779684
      14         8      0.00786843487117
      14         9      0.00786843487117
      14        10      0.00082796549693
      14        11      0.00082796960982
      14        12      0.00021316164550
      14        13      0.00021316233794
      14        14      0.01243953831303
      14        15      0.00184014806427
      14        16      0.00184014806427
      14        17      0.00532577218807
      15         0      0.00015927683588
      15         1      0.00019885058497
      15         2      0.00007840279278
      15         3      0.00051699308576
      15         4      0.00020381135541
      15         5      0.00012464344301
      15         6      0.00043714322404
      15         7      0.00049735267177
      15         8      0.00522908751617
      15         9      0.00180605864653
      15        10      0.00054471071417
      15        11      0.00054471071417
      15        12      0.00197237677929
      15        13      0.00197237677929
      15        14      0.00184014806427
      15        15      0.00785878908070
      15        16      0.00102682014569
      15        17      0.00235533600114
      16         0      0.00015927683588
      16         1      0.00019885058497
      16         2      0.00051699308576
      16         3      0.00007840279278
      16         4      0.00012464344301
      16         5      0.00020381135541
      16         6      0.00043714322404
      16         7      0.00049735267177
      16         8      0.00180605864653
      16         9      0.00522908751617
      16        10      0.00054471071417
      16        11      0.00054471071417
      16        12      0.00197237677929
      16        13      0.00197237677929
      16        14      0.00184014806427
      16        15      0.00102682014569
      16        16      0.00785878908070
      16        17      0.00235533600114
      17         0      0.00030512225116
      17         1      0.00079478994870
      17         2      0.00051591669569
      17         3      0.00051591669569
      17         4      0.00079958292364
      17         5      0.00079958292364
      17         6      0.00040402486402
      17         7      0.00107558697129
      17         8      0.00124203842194
      17         9      0.00124203842194
      17        10      0.00012000905960
      17        11      0.00012001019017
      17        12      0.00049252010542
      17        13      0.00049252059613
      17        14      0.00532577218807
      17        15      0.00235533600114
      17        16      0.00235533600114
      17        17      0.00805615262953
CCAA
       0         0      0.00359160638383
       0         1      0.00007268478296
       1         0      0.00007268478296
       1         1      0.00330361592525
CAAV
       0         0      0.00035061140047
       0         1      0.00064434762746
       0         2      0.00109662648813
       0         3      0.00109662648813
       0         4      0.00058082249397
       0         5      0.00058082249397
       0         6      0.00217896549494
       0         7      0.00020894553119
       0         8      0.00156111899453
       0         9      0.00156111899453
       0        10      0.00104713698974
       0        11      0.00104713548054
       0        12      0.00002425529977
       0        13      0.00002425554937
       0        14      0.00170115186709
       0        15      0.00007928322522
       0        16      0.00007928322522
       0        17      0.00029120762273
       1         0      0.00087481966429
       1         1      0.00045555172224
       1         2      0.00090879613733
       1         3      0.00090879613733
       1         4      0.00070096140626
       1         5      0.00070096140626
       1         6      0.00054722738862
       1         7      0.00151076950983
       1         8      0.00016399574006
       1         9      0.00016399574006
       1        10      0.00001396231270
       1        11      0.00001396245588
       1        12      0.00066164082121
       1        13      0.00066164038944
       1        14      0.00019246843286
       1        15      0.00074421708791
       1        16      0.00074421708791
       1        17      0.00075422971572
