# Input files for NEVPT2-VMC paper

This repository contains inputs files used to produce results in
'Efficient multireference perturbation theory without high-order
reduced density matrices', JCP 153, 164120 (2020). It also
contains other files that are not too large. There are additional
README files in subdirectories where appropriate, with further
information on how calculations were performed.

## Software used
- PySCF: https://github.com/pyscf/pyscf
- Sharma group VMC code: https://github.com/sanshar/VMC
- Dice (SHCI code): https://github.com/sanshar/Dice

## Instructions

For a given system, the general procedure is:

1. Run the `prepVMC.py` script. This produces an `FCIDUMP` file with
integrals in the active space. It also produces a larger `FCIDUMP.h5`
file with integrals in the entire orbital space.

2. `cd` to the `dice` directory and run the Dice code, using the
`dice.dat` input file, and producing an output called `dice.out`.

3. Copy the list of all determinants to a file called `dets`. You
will also need to remove the first column of this output. See the
`VMC/test/NEVPT2` directory of the VMC code for examples.

4. The next step is to perform deterministic NEVPT2 for a subset
of classes. This is only performed for certain examples. Here, we
`cd` to the `icpt_python` directory and run the `prepVMC.py` script.
For this to work, we need the `chk` files generated previously, and
also the spatial RDM file generated by Dice, which should be copied
to this directory. Running the `prepVMC.py` script will produce
an `int` directory and input files called `NEVPT_*.inp`. These
should be moved to the `icpt` directory. From here we run the
`VMC/bin/ICPT` executable on each of the `NEVPT_*.inp` input files.
The output files will hold the energies from the respective classes.

5. Next we run the stochastic NEVPT step. For this, `cd` to the
`nevpt` directory where the `vmc.json` file is located. The VMC
NEVPT code needs access to the list of determinants in the active
space (`dets`), the integrals (`FCIDUMP.h5`), the spin RDM
(`spinRDM.0.0.txt`) and the list of molecular orbital energies,
(`moEnergies.txt`). We recommend creating a symbolic link to these
files, for example
```
ln -s ../FCIDUMP.h5 FCIDUMP
```
We then run the VMC code, using the executable `VMC/bin/VMC`,
```
mpirun -np N VMC/bin/VMC vmc.json > nevpt.out
```

6. Finally we run statistical analysis on the results obtained.
The key output from each process is held in the `pt2_energies_*.dat`
files. We run the script `average_nevpt.py` to generate a file
with the average results from each process
```
python3 ~/bin/average_nevpt.py > pt2_energies_avg.dat
```
These results from each process can then be averaged to obtain
final SC-NEVPT2(s) energies.

Note that some of the directories for certain systems contain a
directory called `print_norms`. In this case, a separate
VMC/bin/VMC calculation was performed to generate the norms
of the perturbers. These were then referenced in the final
NEVPT2(s) calculations, using a symbolic link as described
above for `FCIDUMP.h5` files. This is useful when running on
clusters with low wall time limits.

## Hardware used

Most of the calculations were performed on one of two clusters.

- Peta4 (University of Cambridge CSD3)
https://www.hpc.cam.ac.uk/systems/peta-4

- Cerebro Compute Server (University of Cambridge, Department of Chemistry)
https://www.ch.cam.ac.uk/computing/cerebro-compute-server
