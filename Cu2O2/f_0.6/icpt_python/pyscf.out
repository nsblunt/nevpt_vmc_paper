#INFO: **** input file is /state/partition1/nsb37/162182/prepVMC.py ****
import numpy as np
from pyscf import gto, scf, ao2mo, mcscf, tools, fci, mp, symm, lib
from pyscf.shciscf import shci
import math, os, time, sys
import NEVPT2Helper as nev

def myocc(mf):
   mol = mf.mol
   irrep_id = mol.irrep_id
   so = mol.symm_orb
   orbsym = symm.label_orb_symm(mol, irrep_id, so, mf.mo_coeff)
   doccsym = np.array(orbsym)[mf.mo_occ==2]
   soccsym = np.array(orbsym)[mf.mo_occ==1]
   for ir, irname in enumerate(mol.irrep_name):
     print('%s, double-occ = %d, single-occ = %d' %
         (irname, sum(doccsym==ir), sum(soccsym==ir)))

# Cu2O2^2+: bis f = 0., per f = 1.
if len(sys.argv) == 2:
    f = float(sys.argv[1])
else:
    f = 0.

# bond lengths
cu_cu = 2.8 + f * 0.8
o_o = 2.3 - f * 0.9

atomString = 'Cu {} 0. 0.; Cu {} 0. 0.; O 0. {} 0.; O 0. {} 0.'.format(-cu_cu/2, cu_cu/2, o_o/2, -o_o/2)

mol = gto.M(atom = atomString,
    basis = {'O': gto.basis.parse('''
O    S
 105374.95                   0.00012386            -0.00002815             0.00002616            -0.00005058             0.00005196
  15679.240                  0.00051201            -0.00011630             0.00010748            -0.00020024             0.00019612
   3534.5447                 0.00215291            -0.00049092             0.00045972            -0.00091952             0.00099303
    987.36516                0.00852844            -0.00194616             0.00179555            -0.00320240             0.00297658
    315.97875                0.03018049            -0.00700530             0.00667574            -0.01359974             0.01564071
    111.65428                0.09099702            -0.02167814             0.02053445            -0.03392296             0.03231923
     42.699451               0.21779364            -0.05641213             0.05828602            -0.11685462             0.16012253
     17.395596               0.36862457            -0.11270530             0.12129691            -0.14040275             0.15386867
      7.4383090              0.33667073            -0.15891197             0.22641475            -0.47546666             0.93886300
      3.2228620              0.09657630            -0.03355083            -0.04238700             0.83350096            -3.16442722
      1.2538770              0.00214452             0.35319028            -1.01045538             1.30186138             2.94545392
       .49515500             0.00119435             0.55341993            -0.15386868            -2.48175844            -0.46724256
       .19166500             0.00053902             0.23018391             0.99345320             0.81134659            -1.59503813
       .06708300             0.00021034             0.01127267             0.18587254             0.58210417             1.34403482
O    P
    200.00000                0.00091730            -0.00087213             0.00129603            -0.00195602
     46.533367               0.00737714            -0.00706424             0.01151279            -0.02399585
     14.621809               0.03483515            -0.03330489             0.05159120            -0.09118427
      5.3130640              0.11443970            -0.11441275             0.20459407            -0.52863388
      2.1025250              0.25549664            -0.29901068             0.55019345            -0.38198314
       .85022300             0.37225574            -0.31986054            -0.14872038             1.44198816
       .33759700             0.33233149             0.20550900            -0.89690085            -0.67366146
       .12889200             0.14008479             0.59359268             0.24707597            -0.66496950
       .04511200             0.02395784             0.28229027             0.64443405             0.82977107
O    D
      3.7500000              0.13609758            -0.39151953             0.95199748
      1.3125000              0.51401475            -0.62262728            -0.67736624
       .45937500             0.47407125             0.72160073            -0.34608569
       .16078100             0.08166905             0.31870103             0.81524547
O    F
      2.3500000              0.33460642            -0.83677707
       .94000000             0.56136672             0.10721970
       .37600000             0.29572786             0.72955061
O    G
      1.175000               0.89524901
      0.470000               0.166642351
    '''),
    'Cu': gto.basis.parse('''
Cu    S
9148883.                     0.00011722            -0.00003675             0.00001383            -0.00000271             0.00000346            -0.00001401             0.00001043
1369956.                     0.00033155            -0.00010403             0.00003914            -0.00000766             0.00000979            -0.00003959             0.00002948
 311782.6                    0.00088243            -0.00027733             0.00010439            -0.00002047             0.00002626            -0.00010612             0.00007887
  88318.80                   0.00217229            -0.00068417             0.00025745            -0.00005030             0.00006392            -0.00025900             0.00019337
  28815.53                   0.00529547            -0.00167686             0.00063203            -0.00012442             0.00016087            -0.00064865             0.00048021
  10403.46                   0.01296630            -0.00413460             0.00155718            -0.00030269             0.00038023            -0.00154770             0.00116372
   4057.791                  0.03188050            -0.01035127             0.00391659            -0.00077628             0.00101716            -0.00408342             0.00300351
   1682.974                  0.07576569            -0.02534791             0.00959476            -0.00185240             0.00229152            -0.00940206             0.00715331
    733.7543                 0.16244637            -0.05836947             0.02238837            -0.00448270             0.00597497            -0.02389117             0.01749000
    333.2677                 0.28435959            -0.11673284             0.04528606            -0.00866024             0.01044695            -0.04359832             0.03399715
    156.4338                 0.34173643            -0.18466860             0.07498378            -0.01544726             0.02151583            -0.08588857             0.06315941
     74.69721                0.20955087            -0.14700899             0.06188170            -0.01089864             0.01030128            -0.04734865             0.04023075
     33.32262                0.03544751             0.18483257            -0.09047327             0.01467867            -0.00984324             0.06382592            -0.07818080
     16.62237               -0.00243996             0.56773609            -0.39288472             0.09154122            -0.14292630             0.59363541            -0.48734052
      8.208260               0.00146990             0.37956092            -0.35664956             0.06330857            -0.05612707             0.41506062            -0.33346978
      3.609400              -0.00064379             0.04703755             0.34554793            -0.06093879             0.09135650            -1.70027942             2.60302086
      1.683449               0.00024738            -0.00072783             0.70639197            -0.27148545             0.45831402            -0.29799956            -2.74603469
      0.733757              -0.00008118             0.00102976             0.25335911            -0.10138944            -0.19726740             1.70719425             0.71954394
      0.110207               0.00001615            -0.00007020             0.00658749             0.71212180            -1.30310157            -0.65600053             1.53198225
      0.038786              -0.00001233             0.00007090            -0.00044247             0.34613175             0.87975568            -0.31924524            -3.06314771
      0.015514               0.00000452            -0.00002454             0.00072338             0.07198709             0.57310889             0.61772456             2.02100706
Cu    P
   9713.253                  0.00039987            -0.00014879             0.00005053            -0.00015878             0.00012679            -0.00022000
   2300.889                  0.00210157            -0.00078262             0.00026719            -0.00085359             0.00068397            -0.00104834
    746.7706                 0.01001097            -0.00376229             0.00127718            -0.00399919             0.00320291            -0.00581612
    284.6806                 0.03836039            -0.01457968             0.00499760            -0.01608092             0.01301351            -0.01983336
    119.9999                 0.11626756            -0.04571093             0.01561376            -0.04924864             0.04021371            -0.07638917
     54.07386                0.25899831            -0.10593013             0.03689701            -0.12165679             0.10150109            -0.15366480
     25.37321                0.38428226            -0.16836228             0.05796469            -0.17713367             0.13700954            -0.28449754
     12.20962                0.29911210            -0.10373213             0.03791966            -0.14448197             0.10628972             0.10206373
      5.757421               0.08000672             0.21083155            -0.11706499             0.64743311            -0.83390265             1.55100061
      2.673402               0.00319440             0.48916443            -0.20912257             0.54797692             0.14412002            -1.84574442
      1.186835               0.00147252             0.38468638            -0.05800532            -0.78180321             0.98301239             0.10057714
      0.481593              -0.00023391             0.08529338             0.16430736            -0.52607778            -0.52956418             1.39430453
      0.192637               0.00020761            -0.00161045             0.52885466             0.22437177            -0.75303984            -1.12548146
      0.077055              -0.00008963             0.00206530             0.37373016             0.33392453             0.44288700            -0.18571375
      0.030822               0.00002783            -0.00064175             0.08399866             0.14446374             0.57511589             0.70628395
Cu    D
    249.3497                 0.00134561            -0.00158359             0.00191116            -0.00316569
     74.63837                0.01080983            -0.01281116             0.01772495            -0.03710740
     28.37641                0.04733793            -0.05642679             0.07056381            -0.12591409
     11.94893                0.13772582            -0.16641393             0.22906101            -0.49360952
      5.317646               0.26263833            -0.35106014             0.43938511            -0.16251663
      2.364417               0.33470401            -0.23717890            -0.26739908             1.00715586
      1.012386               0.31000597             0.21994641            -0.62590624            -0.32192167
      0.406773               0.21316819             0.48841363             0.12211340            -0.61072690
      0.147331               0.07865365             0.29537131             0.53683629             0.39038140
      0.058932               0.00603096             0.04295539             0.19750055             0.37334893
Cu    F
     15.4333                 0.03682063            -0.06200336             0.13301012
      6.1172                 0.24591418            -0.52876669             0.74591931
      2.4246                 0.50112688            -0.29078386            -0.67622545
      0.9610                 0.35850648             0.52124157            -0.31278443
      0.3809                 0.14728062             0.37532205             0.60308069
      0.1510                 0.02564748             0.10659798             0.26056742
Cu    G
      8.7286                 0.16903848            -0.45244412
      3.4308                 0.60654185            -0.42317767
      1.3485                 0.37979899             0.61107957
      0.5300                 0.10367757             0.39786263
Cu    H
      4.2885                 0.69861274
      1.6856                 0.445143741
    ''')},
    verbose = 4, unit = 'angstrom', symmetry = 1, spin = 0, charge = 2)

mf = scf.RHF(mol)
chkfile = 'cu2o2_{}_HF.chk'.format(f)
mf.__dict__.update(scf.chkfile.load(chkfile, 'scf'))

#mf.max_cycle = 500
#mf.kernel()
#myocc(mf)
#mf.analyze()
#tools.molden.from_mo(mol, f'cu2o2_{f}.molden', mf.mo_coeff)

# shciscf
norbAct = 32
nelecAct = 28
mc = shci.SHCISCF(mf, norbAct, nelecAct)
chkfile = 'cu2o2_{}_SHCISCF.chk'.format(f)

# for icpt integrals uncomment the following and comment out the mc calculation, FCIDUMP generation, etc.
mc.__dict__.update(lib.chkfile.load(chkfile, 'mcscf'))

# prep nevpt

norbFrozen = 12
norbCore = 22

#this is the scratch file for writing potentially larger integral files
intfolder = "int/"
os.system("mkdir -p "+intfolder)

dm2a = np.zeros((norbAct, norbAct, norbAct, norbAct))
file2pdm = "spatialRDM.0.0.txt"
file2pdm = file2pdm.encode()  # .encode for python3 compatibility
shci.r2RDM(dm2a, norbAct, file2pdm)
dm1 = np.einsum('ikjj->ki', dm2a)
dm1 /= (nelecAct - 1)
#dm1, dm2a = mc.fcisolver.make_rdm12(0, mc.ncas, mc.nelecas)
dm2 = np.einsum('ijkl->ikjl', dm2a)

np.save(intfolder+"E2.npy", np.asfortranarray(dm2))
np.save(intfolder+"E1.npy", np.asfortranarray(dm1))

print ("trace of 2rdm", np.einsum('ijij',dm2))
print ("trace of 1rdm", np.einsum('ii',dm1))

E1eff = dm1 #for state average
nev.writeNEVPTIntegrals(mc, dm1, dm2, E1eff, norbFrozen, intfolder)
nev.write_ic_inputs(mc.nelecas[0]+mc.nelecas[1], mc.ncore, mc.ncas, norbFrozen, mc.nelecas[0]-mc.nelecas[1],
                   'NEVPT2')
#INFO: ******************** input file end ********************


System: ('Linux', 'compute-0-11.local', '2.6.32-504.16.2.el6.x86_64', '#1 SMP Wed Apr 22 06:48:29 UTC 2015', 'x86_64', 'x86_64')  Threads 12
Python 2.7.15 |Anaconda, Inc.| (default, May  1 2018, 23:32:55) 
[GCC 7.2.0]
numpy 1.15.1  scipy 1.1.0
Date: Fri Jul 17 23:02:48 2020
PySCF version 1.7.1
PySCF path  /home/nsb37/pyscf/pyscf
GIT ORIG_HEAD f9a419e89c2fa6ea63cd0445a6fc1dde4109b47b
GIT HEAD      ref: refs/heads/master
GIT master branch  97008722ba492c9d60fa46535f156620355ae933

[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 4
[INPUT] num. electrons = 72
[INPUT] charge = 2
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry 1 subgroup None
[INPUT] Mole.unit = angstrom
[INPUT]  1 Cu    -1.640000000000   0.000000000000   0.000000000000 AA   -3.099150844287   0.000000000000   0.000000000000 Bohr
[INPUT]  2 Cu     1.640000000000   0.000000000000   0.000000000000 AA    3.099150844287   0.000000000000   0.000000000000 Bohr
[INPUT]  3 O      0.000000000000   0.880000000000   0.000000000000 AA    0.000000000000   1.662958989617   0.000000000000 Bohr
[INPUT]  4 O      0.000000000000  -0.880000000000   0.000000000000 AA    0.000000000000  -1.662958989617   0.000000000000 Bohr

nuclear repulsion = 418.776999768163
point group symmetry = D2h
num. orbitals of irrep Ag = 58
num. orbitals of irrep B1g = 36
num. orbitals of irrep B2g = 30
num. orbitals of irrep B3g = 26
num. orbitals of irrep Au = 20
num. orbitals of irrep B1u = 36
num. orbitals of irrep B2u = 45
num. orbitals of irrep B3u = 49
number of shells = 22
number of NR pGTOs = 632
number of NR cGTOs = 300
basis = {'Cu': [[0, [9148883.0, 0.00011722, -3.675e-05, 1.383e-05, -2.71e-06, 3.46e-06, -1.401e-05, 1.043e-05], [1369956.0, 0.00033155, -0.00010403, 3.914e-05, -7.66e-06, 9.79e-06, -3.959e-05, 2.948e-05], [311782.6, 0.00088243, -0.00027733, 0.00010439, -2.047e-05, 2.626e-05, -0.00010612, 7.887e-05], [88318.8, 0.00217229, -0.00068417, 0.00025745, -5.03e-05, 6.392e-05, -0.000259, 0.00019337], [28815.53, 0.00529547, -0.00167686, 0.00063203, -0.00012442, 0.00016087, -0.00064865, 0.00048021], [10403.46, 0.0129663, -0.0041346, 0.00155718, -0.00030269, 0.00038023, -0.0015477, 0.00116372], [4057.791, 0.0318805, -0.01035127, 0.00391659, -0.00077628, 0.00101716, -0.00408342, 0.00300351], [1682.974, 0.07576569, -0.02534791, 0.00959476, -0.0018524, 0.00229152, -0.00940206, 0.00715331], [733.7543, 0.16244637, -0.05836947, 0.02238837, -0.0044827, 0.00597497, -0.02389117, 0.01749], [333.2677, 0.28435959, -0.11673284, 0.04528606, -0.00866024, 0.01044695, -0.04359832, 0.03399715], [156.4338, 0.34173643, -0.1846686, 0.07498378, -0.01544726, 0.02151583, -0.08588857, 0.06315941], [74.69721, 0.20955087, -0.14700899, 0.0618817, -0.01089864, 0.01030128, -0.04734865, 0.04023075], [33.32262, 0.03544751, 0.18483257, -0.09047327, 0.01467867, -0.00984324, 0.06382592, -0.0781808], [16.62237, -0.00243996, 0.56773609, -0.39288472, 0.09154122, -0.1429263, 0.59363541, -0.48734052], [8.20826, 0.0014699, 0.37956092, -0.35664956, 0.06330857, -0.05612707, 0.41506062, -0.33346978], [3.6094, -0.00064379, 0.04703755, 0.34554793, -0.06093879, 0.0913565, -1.70027942, 2.60302086], [1.683449, 0.00024738, -0.00072783, 0.70639197, -0.27148545, 0.45831402, -0.29799956, -2.74603469], [0.733757, -8.118e-05, 0.00102976, 0.25335911, -0.10138944, -0.1972674, 1.70719425, 0.71954394], [0.110207, 1.615e-05, -7.02e-05, 0.00658749, 0.7121218, -1.30310157, -0.65600053, 1.53198225], [0.038786, -1.233e-05, 7.09e-05, -0.00044247, 0.34613175, 0.87975568, -0.31924524, -3.06314771], [0.015514, 4.52e-06, -2.454e-05, 0.00072338, 0.07198709, 0.57310889, 0.61772456, 2.02100706]], [1, [9713.253, 0.00039987, -0.00014879, 5.053e-05, -0.00015878, 0.00012679, -0.00022], [2300.889, 0.00210157, -0.00078262, 0.00026719, -0.00085359, 0.00068397, -0.00104834], [746.7706, 0.01001097, -0.00376229, 0.00127718, -0.00399919, 0.00320291, -0.00581612], [284.6806, 0.03836039, -0.01457968, 0.0049976, -0.01608092, 0.01301351, -0.01983336], [119.9999, 0.11626756, -0.04571093, 0.01561376, -0.04924864, 0.04021371, -0.07638917], [54.07386, 0.25899831, -0.10593013, 0.03689701, -0.12165679, 0.10150109, -0.1536648], [25.37321, 0.38428226, -0.16836228, 0.05796469, -0.17713367, 0.13700954, -0.28449754], [12.20962, 0.2991121, -0.10373213, 0.03791966, -0.14448197, 0.10628972, 0.10206373], [5.757421, 0.08000672, 0.21083155, -0.11706499, 0.64743311, -0.83390265, 1.55100061], [2.673402, 0.0031944, 0.48916443, -0.20912257, 0.54797692, 0.14412002, -1.84574442], [1.186835, 0.00147252, 0.38468638, -0.05800532, -0.78180321, 0.98301239, 0.10057714], [0.481593, -0.00023391, 0.08529338, 0.16430736, -0.52607778, -0.52956418, 1.39430453], [0.192637, 0.00020761, -0.00161045, 0.52885466, 0.22437177, -0.75303984, -1.12548146], [0.077055, -8.963e-05, 0.0020653, 0.37373016, 0.33392453, 0.442887, -0.18571375], [0.030822, 2.783e-05, -0.00064175, 0.08399866, 0.14446374, 0.57511589, 0.70628395]], [2, [249.3497, 0.00134561, -0.00158359, 0.00191116, -0.00316569], [74.63837, 0.01080983, -0.01281116, 0.01772495, -0.0371074], [28.37641, 0.04733793, -0.05642679, 0.07056381, -0.12591409], [11.94893, 0.13772582, -0.16641393, 0.22906101, -0.49360952], [5.317646, 0.26263833, -0.35106014, 0.43938511, -0.16251663], [2.364417, 0.33470401, -0.2371789, -0.26739908, 1.00715586], [1.012386, 0.31000597, 0.21994641, -0.62590624, -0.32192167], [0.406773, 0.21316819, 0.48841363, 0.1221134, -0.6107269], [0.147331, 0.07865365, 0.29537131, 0.53683629, 0.3903814], [0.058932, 0.00603096, 0.04295539, 0.19750055, 0.37334893]], [3, [15.4333, 0.03682063, -0.06200336, 0.13301012], [6.1172, 0.24591418, -0.52876669, 0.74591931], [2.4246, 0.50112688, -0.29078386, -0.67622545], [0.961, 0.35850648, 0.52124157, -0.31278443], [0.3809, 0.14728062, 0.37532205, 0.60308069], [0.151, 0.02564748, 0.10659798, 0.26056742]], [4, [8.7286, 0.16903848, -0.45244412], [3.4308, 0.60654185, -0.42317767], [1.3485, 0.37979899, 0.61107957], [0.53, 0.10367757, 0.39786263]], [5, [4.2885, 0.69861274], [1.6856, 0.445143741]]], 'O': [[0, [105374.95, 0.00012386, -2.815e-05, 2.616e-05, -5.058e-05, 5.196e-05], [15679.24, 0.00051201, -0.0001163, 0.00010748, -0.00020024, 0.00019612], [3534.5447, 0.00215291, -0.00049092, 0.00045972, -0.00091952, 0.00099303], [987.36516, 0.00852844, -0.00194616, 0.00179555, -0.0032024, 0.00297658], [315.97875, 0.03018049, -0.0070053, 0.00667574, -0.01359974, 0.01564071], [111.65428, 0.09099702, -0.02167814, 0.02053445, -0.03392296, 0.03231923], [42.699451, 0.21779364, -0.05641213, 0.05828602, -0.11685462, 0.16012253], [17.395596, 0.36862457, -0.1127053, 0.12129691, -0.14040275, 0.15386867], [7.438309, 0.33667073, -0.15891197, 0.22641475, -0.47546666, 0.938863], [3.222862, 0.0965763, -0.03355083, -0.042387, 0.83350096, -3.16442722], [1.253877, 0.00214452, 0.35319028, -1.01045538, 1.30186138, 2.94545392], [0.495155, 0.00119435, 0.55341993, -0.15386868, -2.48175844, -0.46724256], [0.191665, 0.00053902, 0.23018391, 0.9934532, 0.81134659, -1.59503813], [0.067083, 0.00021034, 0.01127267, 0.18587254, 0.58210417, 1.34403482]], [1, [200.0, 0.0009173, -0.00087213, 0.00129603, -0.00195602], [46.533367, 0.00737714, -0.00706424, 0.01151279, -0.02399585], [14.621809, 0.03483515, -0.03330489, 0.0515912, -0.09118427], [5.313064, 0.1144397, -0.11441275, 0.20459407, -0.52863388], [2.102525, 0.25549664, -0.29901068, 0.55019345, -0.38198314], [0.850223, 0.37225574, -0.31986054, -0.14872038, 1.44198816], [0.337597, 0.33233149, 0.205509, -0.89690085, -0.67366146], [0.128892, 0.14008479, 0.59359268, 0.24707597, -0.6649695], [0.045112, 0.02395784, 0.28229027, 0.64443405, 0.82977107]], [2, [3.75, 0.13609758, -0.39151953, 0.95199748], [1.3125, 0.51401475, -0.62262728, -0.67736624], [0.459375, 0.47407125, 0.72160073, -0.34608569], [0.160781, 0.08166905, 0.31870103, 0.81524547]], [3, [2.35, 0.33460642, -0.83677707], [0.94, 0.56136672, 0.1072197], [0.376, 0.29572786, 0.72955061]], [4, [1.175, 0.89524901], [0.47, 0.166642351]]]}
ecp = {}
CPU time:         0.57
('trace of 2rdm', 756.0000004493777)
('trace of 1rdm', 28.00000001664362)
Producing the integrals
......production of INT took     305.30 sec

Energy_nuc  =  418.77699977
Energy_core = -3641.93064956
Energy      = -3412.23419024

WARNING: Have to use natural orbitals from CAASCF
         offdiagonal elements:      0.000942

('Basic ingredients written to int/', 12, 22, 54, 300)
......savings of INGREDIENTS took       1.62 sec

